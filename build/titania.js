(function(){var a=typeof this.global=="object"?this.global:this;a.JS=a.JS||{},JS.ENV=a})(),JS.Package=function(a){var b=JS.Package.OrderedSet;JS.Package._index(this),this._loader=a,this._names=new b,this._deps=new b,this._uses=new b,this._styles=new b,this._observers={},this._events={}},function(a){a.displayName="Package",a.toString=function(){return a.displayName},a.log=function(a){if(typeof window=="undefined")return;typeof window.runtime=="object"&&window.runtime.trace(a),window.console&&console.info&&console.info(a)};var b=a.OrderedSet=function(a){this._members=this.list=[],this._index={};if(!a)return;for(var b=0,c=a.length;b<c;b++)this.push(a[b])};b.prototype.push=function(a){var b=a.id!==undefined?a.id:a,c=this._index;if(c.hasOwnProperty(b))return;c[b]=this._members.length,this._members.push(a)};var c=a.Deferred=function(){this._status="deferred",this._value=null,this._callbacks=[]};c.prototype.callback=function(a,b){this._status==="succeeded"?a.call(b,this._value):this._callbacks.push([a,b])},c.prototype.succeed=function(a){this._status="succeeded",this._value=a;var b;while(b=this._callbacks.shift())b[0].call(b[1],a)},a.ENV=JS.ENV;if((this.document||{}).getElementsByTagName){var d=document.getElementsByTagName("script")[0];a._isIE=d.readyState!==undefined}a.onerror=function(a){throw a},a._throw=function(b){a.onerror(new Error(b))};var e=a.prototype,f=[["requires","_deps"],["uses","_uses"],["styling","_styles"]],g=f.length;while(g--)(function(a){var b=a[0],c=a[1];e[b]=function(){var a=arguments.length,b;for(b=0;b<a;b++)this[c].push(arguments[b]);return this}})(f[g]);e.provides=function(){var b=arguments.length,c;for(c=0;c<b;c++)this._names.push(arguments[c]),a._getFromCache(arguments[c]).pkg=this;return this},e.setup=function(a){return this._onload=a,this},e._on=function(a,b,c){if(this._events[a])return b.call(c);var d=this._observers[a]=this._observers[a]||[];d.push([b,c]),this._load()},e._fire=function(a){if(this._events[a])return!1;this._events[a]=!0;var b=this._observers[a];if(!b)return!0;delete this._observers[a];for(var c=0,d=b.length;c<d;c++)b[c][0].call(b[c][1]);return!0},e._isLoaded=function(b){if(!b&&this.__isLoaded!==undefined)return this.__isLoaded;var c=this._names.list,d=c.length,e,f;while(d--){e=c[d],f=a._getObject(e,this._exports);if(f!==undefined)continue;return b?a._throw("Expected package at "+this._loader+" to define "+e):this.__isLoaded=!1}return this.__isLoaded=!0},e._load=function(){if(!this._fire("request"))return;this._prefetch();var b=this._deps.list.concat(this._uses.list),c=b.length;a.when({load:b}),a.when({complete:this._deps.list},function(){a.when({complete:b,load:[this]},function(){this._fire("complete")},this);var c=this,d=function(a){c._exports=a,c._onload&&c._onload(),c._isLoaded(!0),c._fire("load")};if(this._isLoaded())return this._fire("download"),this._fire("load");if(this._loader===undefined)return a._throw("No load path found for "+this._names.list[0]);typeof this._loader=="function"?this._loader(d):a.Loader.loadFile(this._loader,d,this._source);if(!a.Loader.loadStyle)return;var e=this._styles.list,f=e.length;while(f--)a.Loader.loadStyle(e[f]);this._fire("download")},this)},e._prefetch=function(){if(typeof this._loader!="string"||!a.Loader.fetch)return;this._source=this._source||a.Loader.fetch(this._loader)},e.toString=function(){return"Package:"+this._names.list.join(",")},a.when=function(b,c,d){var e=[],f={},g,h,i;for(g in b){if(!b.hasOwnProperty(g))continue;f[g]=[],h=new a.OrderedSet(b[g]),i=h.list.length;while(i--)e.push([g,h.list[i],i])}var j=i=e.length;if(j===0)return c&&c.call(d,f);while(i--)(function(b){var e=a._getByName(b[1]);e._on(b[0],function(){f[b[0]][b[2]]=a._getObject(b[1],e._exports),j-=1,j===0&&c&&c.call(d,f)})})(e[i])},a._autoIncrement=1,a._indexByPath={},a._indexByName={},a._autoloaders=[],a._index=function(a){a.id=this._autoIncrement,this._autoIncrement+=1},a._getByPath=function(a){var b=a.toString();return this._indexByPath[b]=this._indexByPath[b]||new this(a)},a._getByName=function(a){if(typeof a!="string")return a;var b=this._getFromCache(a);if(b.pkg)return b.pkg;var c=this._manufacture(a);if(c)return c;var d=new this;return d.provides(a),d},a.remove=function(a){var b=this._getByName(a);delete this._indexByName[a],delete this._indexByPath[b._loader]},a._autoload=function(a,b){this._autoloaders.push([a,b])},a._manufacture=function(a){var b=this._autoloaders,c=b.length,d,e,f;for(d=0;d<c;d++){e=b[d];if(!e[0].test(a))continue;f=e[1].from+"/"+a.replace(/([a-z])([A-Z])/g,function(a,b,c){return b+"_"+c}).replace(/\./g,"/").toLowerCase()+".js";var g=new this(f);return g.provides(a),(f=e[1].require)&&g.requires(a.replace(e[0],f)),g}return null},a._getFromCache=function(a){return this._indexByName[a]=this._indexByName[a]||{}},a._getObject=function(a,b){if(typeof a!="string")return undefined;var c=b?{}:this._getFromCache(a);if(c.obj!==undefined)return c.obj;var d=b||this.ENV,e=a.split("."),f;while(f=e.shift())d=d&&d[f];return b&&d===undefined?this._getObject(a):c.obj=d}}(JS.Package),JS.Package.DomLoader={HOST_REGEX:/^https?\:\/\/[^\/]+/i,usable:function(){return!!JS.Package._getObject("window.document.getElementsByTagName")},__FILE__:function(){var a=document.getElementsByTagName("script");return src=a[a.length-1].src,url=window.location.href,/^\w+\:\/\//.test(src)?src:/^\//.test(src)?window.location.origin+src:url.replace(/[^\/]*$/g,"")+src},cacheBust:function(a){var b=(new Date).getTime();return a+(/\?/.test(a)?"&":"?")+b},fetch:function(a){JS.cacheBust&&(a=this.cacheBust(a)),this.HOST=this.HOST||this.HOST_REGEX.exec(window.location.href);var b=this.HOST_REGEX.exec(a);if(!this.HOST||b&&b[0]!==this.HOST[0])return null;JS.Package.log("Loading "+a);var c=new JS.Package.Deferred,d=this,e=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;return e.open("GET",a,!0),e.onreadystatechange=function(){if(e.readyState!==4)return;e.onreadystatechange=d._K,c.succeed(e.responseText),e=null},e.send(null),c},loadFile:function(a,b,c){JS.cacheBust&&!c&&(a=this.cacheBust(a));var d=this,e=document.getElementsByTagName("head")[0],f=document.createElement("script");f.type="text/javascript";if(c)return c.callback(function(c){JS.Package.log("Executing "+a),e.appendChild(f),f.text=c,b()});JS.Package.log("Loading and executing "+a),f.src=a,f.onload=f.onreadystatechange=function(){var a=f.readyState,c=f.status;if(!a||a==="loaded"||a==="complete"||a===4&&c===200)b(),f.onload=f.onreadystatechange=d._K,e=null,f=null},e.appendChild(f)},loadStyle:function(a){var b=document.createElement("link");b.rel="stylesheet",b.type="text/css",b.href=a,document.getElementsByTagName("head")[0].appendChild(b)},_K:function(){}},JS.Package.Loader=JS.Package.DomLoader,JS.Package.DSL={__FILE__:function(){return JS.Package.Loader.__FILE__()},pkg:function(a,b){var c=b?JS.Package._getByPath(b):JS.Package._getByName(a);return c.provides(a),c},file:function(a){return JS.Package._getByPath(a)},load:function(a,b){JS.Package.Loader.loadFile(a,b)},autoload:function(a,b){JS.Package._autoload(a,b)}},JS.Package.DSL.loader=JS.Package.DSL.file,JS.Packages=function(a){a.call(JS.Package.DSL)},JS.cacheBust=!1,JS.load=function(a,b){return JS.Package.Loader.loadFile(a,function(){typeof b=="function"&&b()}),this},JS.require=function(){var a=[],b=0;while(typeof arguments[b]=="string")a.push(arguments[b]),b+=1;var c=arguments[b],d=arguments[b+1];return JS.Package.when({complete:a},function(a){if(!c)return;c.apply(d||null,a&&a.complete)}),this},function(){var a=typeof this.global=="object"?this.global:this;a.JS=a.JS||{},JS.ENV=a}(),JS.END_WITHOUT_DOT=/([^\.])$/,JS.array=function(a){var b=[],c=a.length;while(c--)b[c]=a[c];return b},JS.bind=function(a,b){return function(){return a.apply(b,arguments)}},JS.extend=function(a,b,c){if(!a||!b)return a;for(var d in b){if(a[d]===b[d])continue;if(c===!1&&a.hasOwnProperty(d))continue;a[d]=b[d]}return a},JS.indexOf=function(a,b){if(a.indexOf)return a.indexOf(b);var c=a.length;while(c--)if(a[c]===b)return c;return-1},JS.isType=function(a,b){return typeof b=="string"?typeof a===b:a===null||a===undefined?!1:typeof b=="function"&&a instanceof b||a.isA&&a.isA(b)||a.constructor===b},JS.makeBridge=function(a){var b=function(){};return b.prototype=a.prototype,new b},JS.makeClass=function(a){a=a||Object;var b=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this};return b.prototype=JS.makeBridge(a),b.superclass=a,b.subclasses=[],a.subclasses&&a.subclasses.push(b),b},JS.match=function(a,b){return b===undefined?!1:typeof a.test=="function"?a.test(b):a.match(b)},JS.Method=JS.makeClass(),JS.extend(JS.Method.prototype,{initialize:function(a,b,c){this.module=a,this.name=b,this.callable=c,this._words={};if(typeof c!="function")return;this.arity=c.length;var d=c.toString().match(/\b[a-z\_\$][a-z0-9\_\$]*\b/ig),e=d.length;while(e--)this._words[d[e]]=!0},setName:function(a){this.callable.displayName=this.displayName=a},contains:function(a){return this._words.hasOwnProperty(a)},call:function(){return this.callable.call.apply(this.callable,arguments)},apply:function(a,b){return this.callable.apply(a,b)},compile:function(a){var b=this,c=b.module.__trace__||a.__trace__,d=b.callable,e=b._words,f=JS.Method._keywords,g=f.length,h=[],i;while(g--)i=f[g],e[i.name]&&h.push(i);if(h.length===0&&!c)return d;var j=function(){var c=h.length,e=c,f={},g,i,j;while(e--){g=h[e],i=this[g.name];if(i&&!i.__kwd__)continue;f[g.name]={_value:i,_own:this.hasOwnProperty(g.name)},j=g.filter(b,a,this,arguments),j.__kwd__=!0,this[g.name]=j}var k=d.apply(this,arguments),e=c;while(e--){g=h[e];if(!f[g.name])continue;f[g.name]._own?this[g.name]=f[g.name]._value:delete this[g.name]}return k};return c?JS.StackTrace.wrap(j,b,a):j},toString:function(){var a=this.displayName||this.module.toString()+"#"+this.name;return"#<Method:"+a+">"}}),JS.Method.create=function(a,b,c){if(c&&c.__inc__&&c.__fns__)return c;var d=typeof c!="function"?c:new this(a,b,c);return this.notify(d),d},JS.Method.compile=function(a,b){return a&&a.compile?a.compile(b):a},JS.Method.__listeners__=[],JS.Method.added=function(a,b){this.__listeners__.push([a,b])},JS.Method.notify=function(a){var b=this.__listeners__,c=b.length,d;while(c--)d=b[c],d[0].call(d[1],a)},JS.Method._keywords=[],JS.Method.keyword=function(a,b){this._keywords.push({name:a,filter:b})},JS.Method.tracing=function(a,b,c){JS.require("JS.StackTrace",function(){var d=JS.StackTrace.logger,e=d.active;a=[].concat(a),this.trace(a),d.active=!0,b.call(c),this.untrace(a),d.active=e},this)},JS.Method.trace=function(a){var b=a.length;while(b--)a[b].__trace__=!0,a[b].resolve()},JS.Method.untrace=function(a){var b=a.length;while(b--)a[b].__trace__=!1,a[b].resolve()},JS.Module=JS.makeClass(),JS.Module.__queue__=[],JS.extend(JS.Module.prototype,{initialize:function(a,b,c){typeof a!="string"&&(c=arguments[1],b=arguments[0],a=undefined),c=c||{},this.__inc__=[],this.__dep__=[],this.__fns__={},this.__tgt__=c._target,this.__anc__=null,this.__mct__={},this.setName(a),this.include(b,{_resolve:!1}),JS.Module.__queue__&&JS.Module.__queue__.push(this)},setName:function(a){this.displayName=a||"";for(var b in this.__fns__)this.__name__(b);a&&this.__meta__&&this.__meta__.setName(a+".")},__name__:function(a){if(!this.displayName)return;var b=this.__fns__[a];if(!b)return;a=this.displayName.replace(JS.END_WITHOUT_DOT,"$1#")+a;if(typeof b.setName=="function")return b.setName(a);typeof b=="function"&&(b.displayName=a)},define:function(a,b,c){var d=JS.Method.create(this,a,b),e=(c||{})._resolve;this.__fns__[a]=d,this.__name__(a),e!==!1&&this.resolve()},include:function(a,b){if(!a)return this;var b=b||{},c=b._resolve!==!1,d=a.extend,e=a.include,f,g,h,i,j,k;if(a.__fns__&&a.__inc__)this.__inc__.push(a),(a.__dep__||{}).push&&a.__dep__.push(this),(f=b._extended)?typeof a.extended=="function"&&a.extended(f):typeof a.included=="function"&&a.included(this);else{if(this.shouldIgnore("extend",d)){i=[].concat(d);for(j=0,k=i.length;j<k;j++)this.extend(i[j])}if(this.shouldIgnore("include",e)){i=[].concat(e);for(j=0,k=i.length;j<k;j++)this.include(i[j],{_resolve:!1})}for(g in a){if(!a.hasOwnProperty(g))continue;h=a[g];if(this.shouldIgnore(g,h))continue;this.define(g,h,{_resolve:!1})}a.hasOwnProperty("toString")&&this.define("toString",a.toString,{_resolve:!1})}return c&&this.resolve(),this},alias:function(a){for(var b in a){if(!a.hasOwnProperty(b))continue;this.define(b,this.instanceMethod(a[b]),{_resolve:!1})}this.resolve()},resolve:function(a){var a=a||this,b=a.__tgt__,c=this.__inc__,d=this.__fns__,e,f,g,h;if(a===this){this.__anc__=null,this.__mct__={},e=this.__dep__.length;while(e--)this.__dep__[e].resolve()}if(!b)return;for(e=0,f=c.length;e<f;e++)c[e].resolve(a);for(g in d)h=JS.Method.compile(d[g],a),b[g]!==h&&(b[g]=h);d.hasOwnProperty("toString")&&(b.toString=JS.Method.compile(d.toString,a))},shouldIgnore:function(a,b){return(a==="extend"||a==="include")&&(typeof b!="function"||b.__fns__&&b.__inc__)},ancestors:function(a){var b=!a,a=a||[],c=this.__inc__;if(b&&this.__anc__)return this.__anc__.slice();for(var d=0,e=c.length;d<e;d++)c[d].ancestors(a);return JS.indexOf(a,this)<0&&a.push(this),b&&(this.__anc__=a.slice()),a},lookup:function(a){var b=this.__mct__[a];if(b&&b.slice)return b.slice();var c=this.ancestors(),d=[],e;for(var f=0,g=c.length;f<g;f++)e=c[f].__fns__,e.hasOwnProperty(a)&&d.push(e[a]);return this.__mct__[a]=d.slice(),d},includes:function(a){if(a===this)return!0;var b=this.__inc__;for(var c=0,d=b.length;c<d;c++)if(b[c].includes(a))return!0;return!1},instanceMethod:function(a){return this.lookup(a).pop()},instanceMethods:function(a,b){var c=b||[],d=this.__fns__,e;for(e in d){if(!JS.isType(this.__fns__[e],JS.Method))continue;if(JS.indexOf(c,e)>=0)continue;c.push(e)}if(a!==!1){var f=this.ancestors(),g=f.length;while(g--)f[g].instanceMethods(!1,c)}return c},match:function(a){return a&&a.isA&&a.isA(this)},toString:function(){return this.displayName}}),JS.Kernel=new JS.Module("Kernel",{__eigen__:function(){if(this.__meta__)return this.__meta__;var a=this.toString()+".";return this.__meta__=new JS.Module(a,null,{_target:this}),this.__meta__.include(this.klass,{_resolve:!1})},equals:function(a){return this===a},extend:function(a,b){var c=(b||{})._resolve;return this.__eigen__().include(a,{_extended:this,_resolve:c}),this},hash:function(){return JS.Kernel.hashFor(this)},isA:function(a){return typeof a=="function"&&this instanceof a||this.__eigen__().includes(a)},method:function(a){var b=this.__mct__=this.__mct__||{},c=b[a],d=this[a];if(typeof d!="function")return d;if(c&&d===c._value)return c._bound;var e=JS.bind(d,this);return b[a]={_value:d,_bound:e},e},methods:function(){return this.__eigen__().instanceMethods()},tap:function(a,b){return a.call(b||null,this),this},toString:function(){if(this.displayName)return this.displayName;var a=this.klass.displayName||this.klass.toString();return"#<"+a+":"+this.hash()+">"}}),function(){var a=1;JS.Kernel.hashFor=function(b){return b.__hash__!==undefined?b.__hash__:(b.__hash__=((new Date).getTime()+a).toString(16),a+=1,b.__hash__)}}(),JS.Class=JS.makeClass(JS.Module),JS.extend(JS.Class.prototype,{initialize:function(a,b,c,d){typeof a!="string"&&(d=arguments[2],c=arguments[1],b=arguments[0],a=undefined),typeof b!="function"&&(d=c,c=b,b=Object),JS.Module.prototype.initialize.call(this,a),d=d||{};var e=JS.makeClass(b);JS.extend(e,this),e.prototype.constructor=e.prototype.klass=e,e.__eigen__().include(b.__meta__,{_resolve:d._resolve}),e.setName(a),e.__tgt__=e.prototype;var f=b===Object?{}:b.__fns__?b:new JS.Module(b.prototype,{_resolve:!1});return e.include(JS.Kernel,{_resolve:!1}).include(f,{_resolve:!1}).include(c,{_resolve:!1}),d._resolve!==!1&&e.resolve(),typeof b.inherited=="function"&&b.inherited(e),e}}),function(){var a=function(a){var b={},c=a.prototype;for(var d in c){if(!c.hasOwnProperty(d))continue;b[d]=JS.Method.create(a,d,c[d])}return b},b=function(b,c){var d=JS[b],e=JS[c];d.__inc__=[],d.__dep__=[],d.__fns__=a(d),d.__tgt__=d.prototype,d.prototype.constructor=d.prototype.klass=d,JS.extend(d,JS.Class.prototype),d.include(e||JS.Kernel),d.setName(b),d.constructor=d.klass=JS.Class};b("Method"),b("Module"),b("Class","Module");var c=JS.Kernel.instanceMethod("__eigen__");c.call(JS.Method),c.call(JS.Module),c.call(JS.Class).include(JS.Module.__meta__)}(),JS.NotImplementedError=new JS.Class("NotImplementedError",Error),JS.Method.keyword("callSuper",function(a,b,c,d){var e=b.lookup(a.name),f=e.length-1,g=JS.array(d);return function(){var a=arguments.length;while(a--)g[a]=arguments[a];f-=1;var b=e[f].apply(c,g);return f+=1,b}}),JS.Method.keyword("blockGiven",function(a,b,c,d){var e=Array.prototype.slice.call(d,a.arity),f=typeof e[0]=="function";return function(){return f}}),JS.Method.keyword("yieldWith",function(a,b,c,d){var e=Array.prototype.slice.call(d,a.arity);return function(){if(typeof e[0]!="function")return;return e[0].apply(e[1]||null,arguments)}}),JS.Interface=new JS.Class("Interface",{initialize:function(a){this.test=function(b,c){var d=a.length;while(d--)if(typeof b[a[d]]!="function")return c?a[d]:!1;return!0}},extend:{ensure:function(){var a=JS.array(arguments),b=a.shift(),c,d;while(c=a.shift()){d=c.test(b,!0);if(d!==!0)throw new Error("object does not implement "+d+"()")}}}}),JS.Singleton=new JS.Class("Singleton",{initialize:function(a,b,c){return new new JS.Class(a,b,c)}}),global.Helper={},Helper.ifNodeContext=function(a){typeof process!="undefined"&&a()},Helper.ifBrowserContext=function(a){typeof window!="undefined"&&a()},global.Browser=new JS.Class("Browser",{initialize:function(){var a=new Game.Remote("http://"+global.SERVER_HOST+":42000");Helper.requestAnimationLoop(function(){System.Display.render(a.client.view)})}}),global.System={},Helper.ifBrowserContext(function(){System.Display=new JS.Singleton("Systems.Display",{initialize:function(){this.renderer=new THREE.WebGLRenderer;var a=this.renderer.domElement;a.style.position="absolute",a.style.top=a.style.left="0";var b=this,c=function(){b.size=[window.innerWidth,window.innerHeight],b.renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",function(){c()},!1),window.addEventListener("load",function(){window.document.body.appendChild(a)},!1),c()},render:function(a){var b=this.size;a.renderOn(this.renderer,b[0],b[1])}})}),Helper.requestAnimationLoop=function(a){var b=function(c){Helper.requestAnimationFrame(b),a(c)};b(0)},Helper.requestAnimationFrame=function(a){var b=+(new Date);Helper.requestAnimationFrame.gate.call(window,function(){a((new Date-b)/1e3)})},Helper.requestAnimationFrame.gate=function(){var a=function(a){return this.setTimeout(a,1e3/60)};if(typeof window=="object"){var b=["","moz","webkit","ms","o"];for(var c=0,d=b.length;c<d;++c){var e=b[c];e.length?e+="RequestAnimationFrame":e="requestAnimationFrame";if(window[e]){a=window[e];break}}}return a}(),global.Game={},Game.Base=new JS.Class("Game.Base",{initialize:function(){this.client=null,this.server=null}}),Game.Remote=new JS.Class("Game.Remote",Game.Base,{initialize:function(a){this.callSuper(),this.client=new Client.Remote(a),this.client.bootstrap(),this.client.view.activateAxes()}}),global.Client={},JS.Observable=new JS.Module("Observable",{extend:{DEFAULT_METHOD:"update"},addObserver:function(a,b){(this.__observers__=this.__observers__||[]).push({_block:a,_context:b||null})},removeObserver:function(a,b){this.__observers__=this.__observers__||[],b=b||null;var c=this.countObservers();while(c--)if(this.__observers__[c]._block===a&&this.__observers__[c]._context===b){this.__observers__.splice(c,1);return}},removeObservers:function(){this.__observers__=[]},countObservers:function(){return(this.__observers__=this.__observers__||[]).length},notifyObservers:function(){if(!this.isChanged())return;var a=this.countObservers(),b,c,d;while(a--)b=this.__observers__[a],c=b._block,d=b._context,typeof c=="function"?c.apply(d||null,arguments):c[d||JS.Observable.DEFAULT_METHOD].apply(c,arguments)},setChanged:function(a){this.__changed__=a!==!1},isChanged:function(){return this.__changed__===undefined&&(this.__changed__=!0),!!this.__changed__}}),JS.Observable.alias({subscribe:"addObserver",unsubscribe:"removeObserver"},!0),Client.Base=new JS.Class("Client.Base",{include:[JS.Observable],initialize:function(){this.pipeline=null,this.view=new View.Apis},bootstrap:function(){this.plug(Client.Core.Logger.Plugin),this.plug(Client.Core.Protocol.Plugin),this.plug(Client.Core.Player.Plugin);var a=new Client.Event.State.Bootstrap;this.notifyObservers(a),this.pipeline.finalize()},plug:function(a){a.attachClient(this)}}),global.View={},typeof THREE!="undefined"&&(THREE.GeometryUtils.merge=function(a,b,c){var d=b instanceof THREE.Geometry?b:b.geometry,e=b instanceof THREE.Object3D?b.children:undefined,f,g,h,i;b instanceof THREE.Object3D&&b.updateMatrixWorld(!0);if(d!==undefined){var j,k,l=a.vertices.length,m=a.faceVertexUvs[0].length,n=a.vertices,o=d.vertices,p=a.faces,q=d.faces,r=a.faceVertexUvs[0],s=d.faceVertexUvs[0],t={};for(f=0;f<a.materials.length;++f){var u=a.materials[f].id;t[u]=f}b instanceof THREE.Mesh&&(j=b.matrixWorld,k=new THREE.Matrix4,k.extractRotation(j,b.scale));for(f=0,g=o.length;f<g;++f){var v=o[f],w=new THREE.Vertex(v.position.clone());j&&j.multiplyVector3(w.position),n.push(w)}for(f=0,g=q.length;f<g;++f){var x=q[f],y,z,A,B=x.vertexNormals,C=x.vertexColors;x instanceof THREE.Face3?y=new THREE.Face3(x.a+l,x.b+l,x.c+l):x instanceof THREE.Face4&&(y=new THREE.Face4(x.a+l,x.b+l,x.c+l,x.d+l)),y.normal.copy(x.normal),k&&k.multiplyVector3(y.normal);for(h=0,i=B.length;h<i;++h)z=B[h].clone(),k&&k.multiplyVector3(z),y.vertexNormals.push(z);y.color.copy(x.color);for(h=0,i=C.length;h<i;++h)A=C[h],y.vertexColors.push(A.clone());if(x.materialIndex!==undefined){var D=d.materials[x.materialIndex],E=D.id,F=t[E];F===undefined&&(F=a.materials.length,a.materials.push(D)),y.materialIndex=F}y.centroid.copy(x.centroid),j&&j.multiplyVector3(y.centroid),p.push(y)}for(f=0,g=s.length;f<g;++f){var G=s[f],H=[];for(h=0,i=G.length;h<i;++h)H.push(new THREE.UV(G[h].u,G[h].v));r.push(H)}}if(c===!0&&e!==undefined)for(f=0,g=e.length;f<g;++f)this.merge(a,e[f])}),View.Details=new JS.Class("View.Details",{initialize:function(){this.scene=new THREE.Scene,this.cameras=[],this.voxels={},this.pendingVoxels={},this.voxelGeometry=null,this.voxelEntity=null},refreshVoxelFaces:function(a){var b=this,c=this.voxels,d=new Value3,e=function(e,f,g){d.set(a.x+e,a.y+f,a.z+g),c.hasOwnProperty(d)&&c[d].setFaces(b.getVoxelFaces(d))};e(0,0,0),e(1,0,0),e(-1,0,0),e(0,1,0),e(0,-1,0),e(0,1,0),e(0,-1,0)},getVoxelFaces:function(a){var b=this.voxels,c=new Value3;return{px:!b.hasOwnProperty(c.add(a,{x:1,y:0,z:0})),nx:!b.hasOwnProperty(c.add(a,{x:-1,y:0,z:0})),py:!b.hasOwnProperty(c.add(a,{x:0,y:1,z:0})),ny:!b.hasOwnProperty(c.add(a,{x:0,y:-1,z:0})),pz:!b.hasOwnProperty(c.add(a,{x:0,y:0,z:1})),nz:!b.hasOwnProperty(c.add(a,{x:0,y:0,z:-1}))}},finishPendingVoxels:function(){var a=this.voxels,b=this.pendingVoxels;this.pendingVoxels={};for(var c in b)if(b.hasOwnProperty(c)){var d=a[c],e=b[c];d.setFaces(this.getVoxelFaces(e)),d.setVoxelPosition(e)}},buildVoxelGeometry:function(){var a=this.voxels,b=this.voxelGeometry=new THREE.Geometry;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c],e=d.object3D;e&&THREE.GeometryUtils.merge(b,e,!0)}},buildVoxelEntity:function(){this.voxelEntity&&this.scene.remove(this.voxelEntity),this.voxelEntity=new THREE.Mesh(this.voxelGeometry,new THREE.MeshFaceMaterial),this.scene.add(this.voxelEntity)}}),global.Value3=new JS.Class("Value3",{extend:{fromArray:function(a){return new this(a[0],a[1],a[2])}},initialize:function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},clone:function(){return new this.klass(this.x,this.y,this.z)},toArray:function(){return[this.x,this.y,this.z]},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},set:function(a,b,c){return this.x=a,this.y=b,this.z=c,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setZ:function(a){return this.z=a,this},add:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},substract:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},multiply:function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},divide:function(a,b){return this.x=a.x/b.x,this.y=a.y/b.y,this.z=a.z/b.z,this},modulo:function(a,b){return this.x=a.x%b.x,this.x=a.y%b.y,this.x=a.z%b.z,this},addSelf:function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},substractSelf:function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},multiplySelf:function(a){return this.x*=a.x,this.y*=a.y,this.z*=a.z,this},divideSelf:function(a){return this.x/=a.x,this.y/=a.y,this.z/=a.z,this},moduloSelf:function(a){return this.x%=a.x,this.y%=a.y,this.z%=a.z,this},addScalar:function(a){return this.x+=a,this.y+=a,this.z+=a,this},substractScalar:function(a){return this.x-=a,this.y-=a,this.z-=a,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this},divideScalar:function(a){return this.x/=a,this.y/=a,this.z/=a,this},moduloScalar:function(a){return this.x%=a,this.y%=a,this.z%=a,this},toString:function(){return[this.x,this.y,this.z].toString()}}),View.Module={},View.Module.Cameras=new JS.Module({createCamera:function(a){var b=new a;return this.cameras.push(b.object3D),this.scene.add(b.object3D),b},removeCamera:function(a){var b=a.object3D,c=this.cameras.indexOf(b);c!==-1&&(this.cameras.slice(c,1),this.scene.remove(b))}}),View.Camera={},View.Module.Characters=new JS.Module({createCharacter:function(a){var b=new a;return this.scene.add(b.object3D),b},removeCharacter:function(a){this.scene.remove(a.object3D)}}),View.Module.Debug=new JS.Module({activateAxes:function(){this.scene.add(new THREE.AxisHelper)},activateLights:function(){this.scene.add(new THREE.AmbientLight(12303291)),this.scene.add(new THREE.PointLight(16777215))}}),View.Module.Voxels=new JS.Module({createVoxel:function(a,b){var c=new b;return this.voxels[a]=c,this.pendingVoxels[a]=a.clone(),this.voxelGeometry=null,c},clearVoxel:function(a){this.voxels[a]=null,this.refreshVoxelFaces(a),this.voxelGeometry=null},voxelAt:function(a){return this.voxels[a]}}),View.Apis=new JS.Class("View.Apis",View.Details,{include:[View.Module.Cameras,View.Module.Characters,View.Module.Debug,View.Module.Voxels],renderOn:function(a,b,c){if(this.hasOwnProperty("cameras")){var d=this.cameras;if(d.length>0){this.voxelGeometry===null&&(this.finishPendingVoxels(),this.buildVoxelGeometry(),this.buildVoxelEntity());var e=d[0];e.aspect=b/c,e.updateProjectionMatrix(),a.render(this.scene,e)}}}}),Client.Core={},Client.Core.Logger={},Client.Core.Logger.Plugin=new JS.Class("Client.Core.Logger.Plugin",{extend:{attachClient:function(a){new this(a)}},initialize:function(a){this.client=a,this.client.addObserver(this.method("clientObserver")),this.client.pipeline.addObserver(this.method("pipelineObserver"))},log:function(a){console.log("[Client] "+a)},clientObserver:function(a){switch(a.klass){case Client.Event.State.Bootstrap:this.log("Client bootstraped");break;case Client.Core.Protocol.Event.Player.Join:this.log("Player join");break;case Client.Core.Protocol.Event.Player.Part:this.log("Player part")}},pipelineObserver:function(a){switch(a.klass){case Pipeline.Event.Connection:this.log("Connection started. Waiting for server acceptance.");break;case Pipeline.Event.Disconnection:this.log("Connection dropped.");break;case Client.Core.Protocol.Event.Connection.Accept:this.log("Connection accepted by the server");break;case Client.Core.Protocol.Event.Connection.Deny:this.log("Connection denied by the server")}}}),Client.Event={},Client.Event.Base=new JS.Class("Client.Event",{}),Client.Event.State=new JS.Class("Client.Event.State",Client.Event.Base,{}),Client.Event.State.Base=new JS.Class("Client.Event.State.Base",Client.Event.Base,{}),Client.Event.State.Bootstrap=new JS.Class("Client.Event.State.Bootstrap",Client.Event.State.Base,{}),Client.Core.Protocol={},Client.Core.Protocol.Event={},Client.Core.Protocol.Event.Connection={},global.Event={},Event.Base=new JS.Class("Event.Base",{}),Client.Core.Protocol.Event.Base=new JS.Class("Client.Core.Protocol.Event.Base",Event.Base,{}),Client.Core.Protocol.Event.Connection.Base=new JS.Class("Client.Core.Protocol.Event.Connection.Base",Client.Core.Protocol.Event.Base,{}),Client.Core.Protocol.Event.Connection.Accept=new JS.Class("Client.Core.Protocol.Event.Connection.Accept",Client.Core.Protocol.Event.Connection.Base,{}),Client.Core.Protocol.Event.Connection.Deny=new JS.Class("Client.Core.Protocol.Event.Connection.Refused",Client.Core.Protocol.Event.Connection.Base,{}),Client.Core.Protocol.Plugin=new JS.Class("Client.Core.Protocol.Plugin",{extend:{attachClient:function(a){new this(a)}},initialize:function(a){this.client=a,this.client.pipeline.addObserver(this.method("observer"))},observer:function(a){switch(a.klass){case Pipeline.Event.Connection:this.startTransaction();break;case Pipeline.Event.Disconnection:this.endTransaction();break;case Pipeline.Event.Command:var b="on"+a.command[0].toUpperCase()+a.command.substr(1)+"Command";b in this&&this[b](a)}},startTransaction:function(){var a=this.client.pipeline;a.send("handshake",{},function(b){if(b===-1){var c=new Client.Core.Protocole.Event.Connection.Deny;a.notifyObservers(c)}else{this.client.id=b;var d=new Client.Core.Protocol.Event.Connection.Accept;a.notifyObservers(d)}}.bind(this))},endTransaction:function(){},onPlayerJoinCommand:function(a){var b=a.data,c=new Client.Core.Protocol.Event.Player.Join;c.id=b.id,c.position=Value3.fromArray(b.position),c.orientation=Value3.fromArray(b.orientation),this.client.notifyObservers(c)},onPlayerPartCommand:function(a){var b=a.data,c=new Client.Core.Protocol.Event.Player.Part;c.id=b.id,this.client.notifyObservers(c)},onPlayerMoveCommand:function(a){var b=a.data,c=new Client.Core.Protocol.Event.Player.Move;c.id=b.id,c.position=Value3.fromArray(b.position),c.orientation=Value3.fromArray(b.orientation),this.client.notifyObservers(c)}}),global.Pipeline={},Pipeline.Event={},Pipeline.Event.Base=new JS.Class("Pipeline.Event.Base",Event.Base,{}),Pipeline.Event.Connection=new JS.Class("Pipeline.Event.Connection",Pipeline.Event.Base,{}),Pipeline.Event.Disconnection=new JS.Class("Pipeline.Event.Disconnection",Pipeline.Event.Base,{}),Pipeline.Event.Command=new JS.Class("Pipeline.Event.Command",Pipeline.Event.Base,{initialize:function(a){this.aknowledge=a||function(){}}}),Client.Core.Protocol.Event.Player={},Client.Core.Protocol.Event.Player.Base=new JS.Class("Client.Core.Protocol.Event.Player.Base",Client.Core.Protocol.Event.Base,{}),Client.Core.Protocol.Event.Player.Join=new JS.Class("Client.Core.Protocol.Event.Player.Join",Client.Core.Protocol.Event.Player.Base,{}),Client.Core.Protocol.Event.Player.Part=new JS.Class("Client.Core.Protocol.Event.Player.Part",Client.Core.Protocol.Event.Player.Base,{}),Client.Core.Protocol.Event.Player.Move=new JS.Class("Client.Core.Protocol.Event.Player.Move",Client.Core.Protocol.Event.Player.Base,{}),Client.Core.Player={},Client.Core.Player.Plugin=new JS.Class("Client.Core.Player.Plugin",{extend:{attachClient:function(a){new this(a)}},initialize:function(a){this.client=a,this.camera=null,this.characters=[],this.client.addObserver(this.method("observer"))},observer:function(a){switch(a.klass){case Client.Core.Protocol.Event.Player.Join:this.onPlayerJoin(a);break;case Client.Core.Protocol.Event.Player.Part:break;case Client.Core.Protocol.Event.Player.Move:this.moveOther(a)}},onPlayerJoin:function(a){var b=this.client;if(a.id===b.id){var c=this.camera=b.view.createCamera(View.Camera.ThirdPerson);c.setPosition(a.position),c.setOrientation(a.orientation),c.moveFront(200)}else{var d=this.characters[a.playerId]=b.view.createCharacter(View.Character.Cube);d.setPosition(a.position),d.setOrientation(a.orientation)}},moveSelf:function(a){this.camera===null&&(this.camera=this.client.view.createCamera(View.Camera.ThirdPerson),console.log("camera created ... id "));var b=this.camera;b.setPosition(a.position),b.setPitchOrientation(a.pitch)},moveOther:function(a){var b=this.characters;if(!b.hasOwnProperty(a.playerId))return;var c=b[a.playerId];c.setPosition(a.position),c.setOrientation(a.orientation)}}),View.Type={},View.Type.Base=new JS.Class("View.Type.Base",{setPosition:function(a){this.object3D.position.copy(a)},getPosition:function(){return(new Value3).copy(this.object3D.position)},setXPosition:function(a){this.object3D.position.x=a},getXPosition:function(){return this.object3D.position.x},setYPosition:function(a){this.object3D.position.y=a},getYPosition:function(){return this.object3D.position.y},setZPosition:function(a){this.object3D.position.z=a},getZPosition:function(){return this.object3D.position.z},setOrientation
:function(a){this.object3D.rotation.copy(a)},getOrientation:function(){return(new Value3).copy(this.object3D.rotation)},setRollOrientation:function(a){this.object3D.rotation.x=a},getRollOrientation:function(){return this.object3D.rotation.x},setPitchOrientation:function(a){this.object3D.rotation.y=a},getPitchOrientation:function(){return this.object3D.rotation.y},setYawOrientation:function(a){this.object3D.rotation.z=a},getYawOrientation:function(){return this.object3D.rotation.z},move:function(a,b){var c=this.object3D;c.matrixAutoUpdate&&c.updateMatrix(),c.translate(a,b)},moveFront:function(a){this.move(a,new THREE.Vector3(0,0,1))},moveBack:function(a){this.moveFront(-a)},moveLeft:function(a){this.move(a,new THREE.Vector3(1,0,0))},moveRight:function(a){this.moveLeft(-a)},moveUp:function(a){this.move(a,new THREE.Vector3(0,1,0))},moveDown:function(a){this.moveUp(-a)},lookAt:function(a){this.object3D.lookAt((new THREE.Vector3).copy(a))}}),View.Camera.Base=new JS.Class("View.Type.Camera",View.Type.Base,{initialize:function(){}}),View.Camera.ThirdPerson=new JS.Class("View.Camera.ThirdPerson",View.Camera.Base,{initialize:function(){this.object3D=new THREE.PerspectiveCamera(60,0,.1,2e4)}}),View.Character={},View.Character.Base=new JS.Class("View.Character.Base",View.Type.Base,{initialize:function(){}}),View.Character.Cube=new JS.Class("View.Character.Cube",View.Character.Base,{extend:{initialize:function(){this.hasOwnProperty("geometry")===!1&&(this.geometry=new THREE.CubeGeometry(5,50,50)),this.hasOwnProperty("material")===!1&&(this.material=new THREE.MeshNormalMaterial)}},initialize:function(){this.callSuper();var a=this.klass;a.initialize(),this.object3D=new THREE.Mesh(a.geometry,a.material)}}),Client.Remote=new JS.Class("Client.Remote",Client.Base,{initialize:function(a){this.callSuper(),this.pipeline=new Pipeline.Remote.create(a)}}),Pipeline.Base=new JS.Class("Pipeline.Base",{include:[JS.Observable],finalize:function(){Helper.pure(this,"finalize")},send:function(a,b,c){Helper.pure(this,"send")},close:function(){Helper.pure(this,"close")}}),Helper.pure=function(a,b){throw new Error("Call to unimplemented pure method '"+b+"' in "+a+".")},Pipeline.Remote=new JS.Class("Pipeline.Remote",Pipeline.Base,{extend:{create:function(a){var b=io.connect(a),c=new Pipeline.Remote(b);return b.on("connect",function(){c.method("finalize")}),c}},initialize:function(a){this.socket=a,this.socket.on("event",function(a,b){var c=new Pipeline.Event.Command(b);c.pipeline=this,c.command=a.command,c.data=a.data,this.notifyObservers(c)}.bind(this)),this.socket.on("disconnect",function(){var a=new Pipeline.Event.Disconnection;a.pipeline=this,this.notifyObservers(a)}.bind(this))},finalize:function(){var a=new Pipeline.Event.Connection;a.pipeline=this,this.notifyObservers(a)},send:function(a,b,c){this.socket.emit("event",{command:a,data:b},c)},close:function(a){this.socket&&(a||this.socketNamespace.disconnect(),this.socketNamespace=null)}}),global.Server={},global.Logic={},Logic.Module={},Logic.Module.Voxels=new JS.Module({voxels:function(){return this._voxels=this._voxels||[]},injectVoxelChunk:function(a,b){var c=new Value3,d=b.length,e=b[0].length,f=b[0][0].length,g=this.voxels();for(c.x=a.x;c.x<d;++c.x)for(c.y=a.y;c.y<e;++c.y)for(c.z=a.z;c.z<f;++c.z)g[c]=b[c.x][c.y][c.z]},setVoxelType:function(a,b){var c=new Logic.Event.Voxel.Access(a);this.notifyObservers(c);var d=this.voxels();if(d.hasOwnProperty(a))return!1;var e=new b,f=new Logic.Event.Voxel.Create.Before(a,e);this.notifyObservers(f);if(beforeVoxelCreationEvent.isCanceled())return!1;d[a]=e;var g=new Logic.Event.Voxel.Create(a,e);return this.notifyObservers(g),!0},removeVoxel:function(a){var b=new Logic.Event.Voxel.Access(a);this.notifyObservers(b);var c=this.voxels();if(!c.hasOwnProperty(a))return!0;var d=c[a],e=new Logic.Event.Voxel.Remove.Before(a,d);this.notifyObservers(e);if(e.isCanceled())return!1;c[a]=null,delete c[a];var f=new Logic.Event.Voxel.Remove(a,d);return this.notifyObservers(f),!0},alterVoxelLife:function(a,b){var c=new Logic.Event.Voxel.Access(a);this.notifyObservers(c);var d=this.voxels();if(!d.hasOwnProperty(a))return!1;if(!b)return!0;var e=d[a],f=new Logic.Event.Voxel.AlterLife.Before(a,e,b);this.notifyObservers(f);if(f.isCanceled())return!1;e.setLife(e.life()-b);var g=new Logic.Event.Voxel.AlterLife(a,e,b);return this.notifyObservers(g),!0}}),Logic.Event={},Logic.Event.Voxel={},Logic.Event.Voxel.Create=new JS.Class("Logic.Event.Voxel.Create",Logic.Event.Voxel.Base,{}),Event.Cancelable=new JS.Module({force:function(){this._forced=!0},cancel:function(){this._canceled=!0},isCanceled:function(){var a=this.hasOwnProperty("_forced")?this._forced:!1,b=this.hasOwnProperty("_canceled")?this._canceled:!1;return!a&&b}}),Logic.Event.Voxel.Create.Before=new JS.Class("Logic.Event.Voxel.Create.Before",Logic.Event.Voxel.Base,{include:[Event.Cancelable]}),Logic.Event.Voxel.Remove=new JS.Class("Logic.Event.Voxel.Remove",Logic.Event.Voxel.Base,{}),Logic.Event.Voxel.Remove.Before=new JS.Class("Logic.Event.Voxel.Remove.Before",Logic.Event.Voxel.Base,{include:[Event.Cancelable]}),Logic.Event.Voxel.AlterLife=new JS.Class("Logic.Event.Voxel.AlterLife",Logic.Event.Voxel.Base,{}),Logic.Event.Voxel.AlterLife.Before=new JS.Class("Logic.Event.Voxel.AlterLife.Before",Logic.Event.Voxel.Base,{include:[Event.Cancelable]}),Logic.Apis=new JS.Class("Logic.Apis",{include:[JS.Observable,Logic.Module.Voxels]}),global.Generator={},JS.Enumerable=new JS.Module("Enumerable",{extend:{ALL_EQUAL:{},forEach:function(a,b){if(!a)return new JS.Enumerator(this,"forEach");for(var c=0;c<this.length;c++)a.call(b||null,this[c]);return this},isComparable:function(a){return a.all(function(a){return typeof a.compareTo=="function"})},areEqual:function(a,b){var c;if(a===b)return!0;if(a&&typeof a.equals=="function")return a.equals(b);if(a instanceof Function)return a===b;if(a instanceof Array){if(b instanceof Array){for(var d=0,e=a.length;d<e;d++){c=this.areEqual(a[d],b[d]);if(c===this.ALL_EQUAL)return!0;if(!c)return!1}return a.length!==b.length?!1:!0}return!1}if(a instanceof Object){if(b instanceof Object){if(this.objectSize(a)!==this.objectSize(b))return!1;for(var f in a)if(!this.areEqual(a[f],b[f]))return!1;return!0}return!1}return!1},objectKeys:function(a,b){var c=[];for(var d in a)(a.hasOwnProperty(d)||b!==!1)&&c.push(d);return c},objectSize:function(a){return this.objectKeys(a).length},Collection:new JS.Class({initialize:function(a){this.length=0,JS.Enumerable.forEach.call(a,this.push,this)},push:function(a){Array.prototype.push.call(this,a)},clear:function(){var a=this.length;while(a--)delete this[a];this.length=0}})},all:function(a,b){a=JS.Enumerable.toFn(a);var c=!0;return this.forEach(function(d){c=c&&(a?a.apply(b||null,arguments):d)}),!!c},any:function(a,b){a=JS.Enumerable.toFn(a);var c=!1;return this.forEach(function(d){c=c||(a?a.apply(b||null,arguments):d)}),!!c},count:function(a,b){if(typeof this.size=="function")return this.size();var c=0,d=a;return a&&typeof a!="function"&&(a=function(a){return JS.Enumerable.areEqual(a,d)}),this.forEach(function(){if(!a||a.apply(b||null,arguments))c+=1}),c},cycle:function(a,b,c){if(!b)return this.enumFor("cycle",a);b=JS.Enumerable.toFn(b);while(a--)this.forEach(b,c)},drop:function(a){var b=[];return this.forEachWithIndex(function(c,d){d>=a&&b.push(c)}),b},dropWhile:function(a,b){if(!a)return this.enumFor("dropWhile");a=JS.Enumerable.toFn(a);var c=[],d=!0;return this.forEach(function(e){d&&(d=d&&a.apply(b||null,arguments)),d||c.push(e)}),c},forEachCons:function(a,b,c){if(!b)return this.enumFor("forEachCons",a);b=JS.Enumerable.toFn(b);var d=this.toArray(),e=d.length,f=e-a,g;for(g=0;g<=f;g++)b.call(c||null,d.slice(g,g+a));return this},forEachSlice:function(a,b,c){if(!b)return this.enumFor("forEachSlice",a);b=JS.Enumerable.toFn(b);var d=this.toArray(),e=d.length,f=Math.ceil(e/a),g;for(g=0;g<f;g++)b.call(c||null,d.slice(g*a,(g+1)*a));return this},forEachWithIndex:function(a,b,c){return typeof a=="function"&&(c=b,b=a,a=0),a=a||0,b?(b=JS.Enumerable.toFn(b),this.forEach(function(d){var e=b.call(c||null,d,a);return a+=1,e})):this.enumFor("forEachWithIndex",a)},forEachWithObject:function(a,b,c){return b?(b=JS.Enumerable.toFn(b),this.forEach(function(){var d=[a].concat(JS.array(arguments));b.apply(c||null,d)}),a):this.enumFor("forEachWithObject",a)},find:function(a,b){if(!a)return this.enumFor("find");a=JS.Enumerable.toFn(a);var c={},d=c;return this.forEach(function(e){if(c!==d)return;c=a.apply(b||null,arguments)?e:c}),c===d?null:c},findIndex:function(a,b){if(a===undefined)return this.enumFor("findIndex");var c=null,d=typeof a=="function";return this.forEachWithIndex(function(e,f){if(c!==null)return;if(JS.Enumerable.areEqual(a,e)||d&&a.apply(b||null,arguments))c=f}),c},first:function(a){var b=this.toArray();return a===undefined?b[0]:b.slice(0,a)},grep:function(a,b,c){b=JS.Enumerable.toFn(b);var d=[];return this.forEach(function(e){var f=typeof a.match=="function"?a.match(e):typeof a.test=="function"?a.test(e):JS.isType(e,a);if(!f)return;b&&(e=b.apply(c||null,arguments)),d.push(e)}),d},groupBy:function(a,b){if(!a)return this.enumFor("groupBy");a=JS.Enumerable.toFn(a);var c=new JS.Hash;return this.forEach(function(d){var e=a.apply(b||null,arguments);c.hasKey(e)||c.store(e,[]),c.get(e).push(d)}),c},inject:function(a,b,c){var d=JS.array(arguments),e=0,f={};switch(d.length){case 1:a=f,b=d[0];break;case 2:typeof a=="function"&&(a=f,b=d[0],c=d[1])}return b=JS.Enumerable.toFn(b),this.forEach(function(d){if(!(e++)&&a===f)return a=d;var g=[a].concat(JS.array(arguments));a=b.apply(c||null,g)}),a},map:function(a,b){if(!a)return this.enumFor("map");a=JS.Enumerable.toFn(a);var c=[];return this.forEach(function(){c.push(a.apply(b||null,arguments))}),c},max:function(a,b){return this.minmax(a,b)[1]},maxBy:function(a,b){return a?this.minmaxBy(a,b)[1]:this.enumFor("maxBy")},member:function(a){return this.any(function(b){return JS.Enumerable.areEqual(b,a)})},min:function(a,b){return this.minmax(a,b)[0]},minBy:function(a,b){return a?this.minmaxBy(a,b)[0]:this.enumFor("minBy")},minmax:function(a,b){var c=this.sort(a,b);return[c[0],c[c.length-1]]},minmaxBy:function(a,b){if(!a)return this.enumFor("minmaxBy");var c=this.sortBy(a,b);return[c[0],c[c.length-1]]},none:function(a,b){return!this.any(a,b)},one:function(a,b){a=JS.Enumerable.toFn(a);var c=0;return this.forEach(function(d){if(a?a.apply(b||null,arguments):d)c+=1}),c===1},partition:function(a,b){if(!a)return this.enumFor("partition");a=JS.Enumerable.toFn(a);var c=[],d=[];return this.forEach(function(e){(a.apply(b||null,arguments)?c:d).push(e)}),[c,d]},reject:function(a,b){if(!a)return this.enumFor("reject");a=JS.Enumerable.toFn(a);var c=[];return this.forEach(function(d){a.apply(b||null,arguments)||c.push(d)}),c},reverseForEach:function(a,b){if(!a)return this.enumFor("reverseForEach");a=JS.Enumerable.toFn(a);var c=this.toArray(),d=c.length;while(d--)a.call(b||null,c[d]);return this},select:function(a,b){if(!a)return this.enumFor("select");a=JS.Enumerable.toFn(a);var c=[];return this.forEach(function(d){a.apply(b||null,arguments)&&c.push(d)}),c},sort:function(a,b){var c=JS.Enumerable.isComparable(this),d=this.toArray();return a=a||(c?function(a,b){return a.compareTo(b)}:null),a?d.sort(function(c,d){return a.call(b||null,c,d)}):d.sort()},sortBy:function(a,b){if(!a)return this.enumFor("sortBy");a=JS.Enumerable.toFn(a);var c=JS.Enumerable,d=new c.Collection(this.map(a,b)),e=c.isComparable(d);return(new c.Collection(d.zip(this).sort(function(a,b){return a=a[0],b=b[0],e?a.compareTo(b):a<b?-1:a>b?1:0}))).map(function(a){return a[1]})},take:function(a){var b=[];return this.forEachWithIndex(function(c,d){d<a&&b.push(c)}),b},takeWhile:function(a,b){if(!a)return this.enumFor("takeWhile");a=JS.Enumerable.toFn(a);var c=[],d=!0;return this.forEach(function(e){d&&(d=d&&a.apply(b||null,arguments)),d&&c.push(e)}),c},toArray:function(){return this.drop(0)},zip:function(){var a=JS.Enumerable,b=[],c=0,d=arguments.length,e,f;typeof arguments[d-1]=="function"&&(e=arguments[d-1],f={}),typeof arguments[d-2]=="function"&&(e=arguments[d-2],f=arguments[d-1]),a.forEach.call(arguments,function(a){if(a===e||a===f)return;a.toArray&&(a=a.toArray()),JS.isType(a,Array)&&b.push(a)});var g=this.map(function(d){var e=[d];return a.forEach.call(b,function(a){e.push(a[c]===undefined?null:a[c])}),++c&&e});if(!e)return g;a.forEach.call(g,e,f)}}),JS.Enumerable.define("forEach",JS.Enumerable.forEach),JS.Enumerable.alias({collect:"map",detect:"find",entries:"toArray",every:"all",findAll:"select",filter:"select",some:"any"}),JS.Enumerable.extend({toFn:function(a){return a?a.toFunction?a.toFunction():this.OPS[a]?this.OPS[a]:JS.isType(a,"string")||JS.isType(a,String)?function(){var b=JS.array(arguments),c=b.shift(),d=c[a];return typeof d=="function"?d.apply(c,b):d}:a:a},OPS:{"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"^":function(a,b){return a^b},"&":function(a,b){return a&b},"&&":function(a,b){return a&&b},"|":function(a,b){return a|b},"||":function(a,b){return a||b},"==":function(a,b){return a==b},"!=":function(a,b){return a!=b},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"<":function(a,b){return a<b},"<=":function(a,b){return a<=b},"===":function(a,b){return a===b},"!==":function(a,b){return a!==b},"[]":function(a,b){return a[b]},"()":function(a,b){return a(b)}},Enumerator:new JS.Class({include:JS.Enumerable,extend:{DEFAULT_METHOD:"forEach"},initialize:function(a,b,c){this._object=a,this._method=b||this.klass.DEFAULT_METHOD,this._args=(c||[]).slice()},equals:function(a){return JS.isType(a,this.klass)&&this._object===a._object&&this._method===a._method&&JS.Enumerable.areEqual(this._args,a._args)},forEach:function(a,b){if(!a)return this;var c=this._args.slice();return c.push(a),b&&c.push(b),this._object[this._method].apply(this._object,c)}})}),JS.Enumerable.Enumerator.alias({cons:"forEachCons",reverse:"reverseForEach",slice:"forEachSlice",withIndex:"forEachWithIndex",withObject:"forEachWithObject"}),JS.Enumerable.Collection.include(JS.Enumerable),JS.Kernel.include({enumFor:function(a){var b=JS.array(arguments),a=b.shift();return new JS.Enumerable.Enumerator(this,a,b)}},{_resolve:!1}),JS.Kernel.alias({toEnum:"enumFor"}),JS.Comparable=new JS.Module("Comparable",{extend:{ClassMethods:new JS.Module({compare:function(a,b){return a.compareTo(b)}}),included:function(a){a.extend(this.ClassMethods)}},lt:function(a){return this.compareTo(a)<0},lte:function(a){return this.compareTo(a)<1},gt:function(a){return this.compareTo(a)>0},gte:function(a){return this.compareTo(a)>-1},eq:function(a){return this.compareTo(a)===0},between:function(a,b){return this.gte(a)&&this.lte(b)}}),JS.Hash=new JS.Class("Hash",{include:JS.Enumerable||{},extend:{Pair:new JS.Class({include:JS.Comparable||{},length:2,setKey:function(a){this[0]=this.key=a},hasKey:function(a){return JS.Enumerable.areEqual(this.key,a)},setValue:function(a){this[1]=this.value=a},hasValue:function(a){return JS.Enumerable.areEqual(this.value,a)},compareTo:function(a){return this.key.compareTo?this.key.compareTo(a.key):this.key<a.key?-1:this.key>a.key?1:0},hash:function(){var a=JS.Hash.codeFor(this.key),b=JS.Hash.codeFor(this.value);return[a,b].sort().join("/")}}),codeFor:function(a){return typeof a!="object"?String(a):typeof a.hash=="function"?a.hash():a.toString()}},initialize:function(a){this.clear();if(!JS.isType(a,Array))return this.setDefault(a);for(var b=0,c=a.length;b<c;b+=2)this.store(a[b],a[b+1])},forEach:function(a,b){if(!a)return this.enumFor("forEach");a=JS.Enumerable.toFn(a);var c,d,e;for(c in this._buckets){if(!this._buckets.hasOwnProperty(c))continue;d=this._buckets[c],e=d.length;while(e--)a.call(b||null,d[e])}return this},_bucketForKey:function(a,b){var c=this.klass.codeFor(a),d=this._buckets[c];return!d&&b&&(d=this._buckets[c]=[]),d},_indexInBucket:function(a,b){var c=a.length,d=!!this._compareByIdentity;while(c--)if(d?a[c].key===b:a[c].hasKey(b))return c;return-1},assoc:function(a,b){var c,d,e;return c=this._bucketForKey(a,b),c?(d=this._indexInBucket(c,a),d>-1?c[d]:b?(this.size+=1,this.length+=1,e=new this.klass.Pair,e.setKey(a),c.push(e),e):null):null},rassoc:function(a){var b=this.key(a);return b?this.assoc(b):null},clear:function(){this._buckets={},this.length=this.size=0},compareByIdentity:function(){return this._compareByIdentity=!0,this},comparesByIdentity:function(){return!!this._compareByIdentity},setDefault:function(a){return this._default=a,this},getDefault:function(a){return typeof this._default=="function"?this._default(this,a):this._default||null},equals:function(a){if(!JS.isType(a,JS.Hash)||this.length!==a.length)return!1;var b=!0;return this.forEach(function(c){if(!b)return;var d=a.assoc(c.key);if(d===null||!d.hasValue(c.value))b=!1}),b},hash:function(){var a=[];return this.forEach(function(b){a.push(b.hash())}),a.sort().join("")},fetch:function(a,b,c){var d=this.assoc(a);if(d)return d.value;if(b===undefined)throw new Error("key not found");return typeof b=="function"?b.call(c||null,a):b},forEachKey:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(c){a.call(b||null,c.key)}),this):this.enumFor("forEachKey")},forEachPair:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(c){a.call(b||null,c.key,c.value)}),this):this.enumFor("forEachPair")},forEachValue:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(c){a.call(b||null,c.value)}),this):this.enumFor("forEachValue")},get:function(a){var b=this.assoc(a);return b?b.value:this.getDefault(a)},hasKey:function(a){return!!this.assoc(a)},hasValue:function(a){var b=!1,c=!!this._compareByIdentity;return this.forEach(function(d){if(b)return;if(c?a===d.value:JS.Enumerable.areEqual(a,d.value))b=!0}),b},invert:function(){var a=new this.klass;return this.forEach(function(b){a.store(b.value,b.key)}),a},isEmpty:function(){for(var a in this._buckets)if(this._buckets.hasOwnProperty(a)&&this._buckets[a].length>0)return!1;return!0},key:function(a){var b=null;return this.forEach(function(c){!b&&JS.Enumerable.areEqual(a,c.value)&&(b=c.key)}),b},keys:function(){var a=[];return this.forEach(function(b){a.push(b.key)}),a},merge:function(a,b,c){var d=new this.klass;return d.update(this),d.update(a,b,c),d},rehash:function(){var a=new this.klass;a._buckets=this._buckets,this.clear(),this.update(a)},remove:function(a,b){b===undefined&&(b=null);var c,d,e;return c=this._bucketForKey(a),c?(d=this._indexInBucket(c,a),d<0?typeof b=="function"?this.fetch(a,b):this.getDefault(a):(e=c[d].value,this._delete(c,d),this.size-=1,this.length-=1,c.length===0&&delete this._buckets[this.klass.codeFor(a)],e)):typeof b=="function"?this.fetch(a,b):this.getDefault(a)},_delete:function(a,b){a.splice(b,1)},removeIf:function(a,b){if(!a)return this.enumFor("removeIf");a=JS.Enumerable.toFn(a);var c=[];this.forEach(function(d){a.call(b||null,d)&&c.push(d.key)},this);var d=c.length;while(d--)this.remove(c[d]);return this},replace:function(a){this.clear(),this.update(a)},shift:function(){var a=this.keys();if(a.length===0)return this.getDefault();var b=this.assoc(a[0]);return this.remove(b.key),b},store:function(a,b){return this.assoc(a,!0).setValue(b),b},toString:function(){return"Hash:{"+this.map(function(a){return a.key.toString()+"=>"+a.value.toString()}).join(",")+"}"},update:function(a,b,c){var d=typeof b=="function";a.forEach(function(a){var e=a.key,f=a.value;d&&this.hasKey(e)&&(f=b.call(c||null,e,this.get(e),f)),this.store(e,f)},this)},values:function(){var a=[];return this.forEach(function(b){a.push(b.value)}),a},valuesAt:function(){var a=arguments.length,b=[];while(a--)b.push(this.get(arguments[a]));return b}}),JS.Hash.alias({includes:"hasKey",index:"key",put:"store"}),JS.OrderedHash=new JS.Class("OrderedHash",JS.Hash,{assoc:function(a,b){var c=JS.Hash.prototype.assoc,d=c.call(this,a,!1);if(d||!b)return d;var e=c.call(this,a,!0);return this._first?(this._last._next=e,e._prev=this._last,this._last=e):this._first=this._last=e,e},clear:function(){this.callSuper(),this._first=this._last=null},_delete:function(a,b){var c=a[b];return c._prev&&(c._prev._next=c._next),c._next&&(c._next._prev=c._prev),c===this._first&&(this._first=c._next),c===this._last&&(this._last=c._prev),this.callSuper()},forEach:function(a,b){if(!a)return this.enumFor("forEach");a=JS.Enumerable.toFn(a);var c=this._first;while(c)a.call(b||null,c),c=c._next},rehash:function(){var a=this._first;this.clear();while(a)this.store(a.key,a.value),a=a._next}}),Generator.Chunk=new JS.Class({initialize:function(a,b){this.position={x:a,z:b},this.blocks=new JS.Hash},fill:function(a){var b=0;for(var c=0;c<16;c++)for(var d=0;d<128;d++)for(var e=0;e<16;e++)this.blocks.put(""+c+";"+d+";"+e,a[b++])},makeLevelAt:function(a,b,c){for(var d=127;d>=0;d--){var e=0;c&&(e=c(d,b-1)),this.blocks.put(""+a[0]+";"+d+";"+a[1],e)}},eraseBlocksBetwin:function(a,b,c,d){for(var e=c;e<=d;e++)this.blocks.put(""+a+";"+e+";"+b,0)},dumpBlocksBetwin:function(a,b){for(var c=0;c<16;c++)for(var d=a;d<b;d++)for(var e=0;e<16;e++)console.log(this.blocks.get(""+c+";"+d+";"+e))},getArray:function(){return this.blocks.values()},dumpAllBlocks:function(){for(var a=0;a<16;a++)for(var b=0;b<128;b++)for(var c=0;c<16;c++)console.log(a+" "+b+" "+c+" "+this.blocks.get(""+a+";"+b+";"+c))}}),Generator.LevelGenerator=new JS.Class({initialize:function(a){this._table=a||this.makeTable(255),this.octaves=20,this.frequency=.01,this.persistence=.45},random:function(){return Math.random()},makeTable:function(a){var b=[];for(var c=0;c<a;++c)b[c]=this.random();return b},cosineInterpolate:function(a,b,c){var d=(1-Math.cos(c*Math.PI))*.5;return(1-d)*a+d*b},_randify:function(a){return this._table[Math.floor(a%this._table.length)]},_noise:function(a){var b=0,c=a.length;for(var d=0;d<c;++d)b=this._randify(Math.floor(b*85e3)+a[d]);return b},_smooth:function(a,b){if(b<0)return this._noise(a);var c=a[b],d=Math.floor(c),e=c-d;a[b]=d;var f=this._smooth(a,b-1);a[b]=d+1;var g=this._smooth(a,b-1);return a[b]=c,this.cosineInterpolate(f,g,e)},_perlin:function(a){var b=0,c=1,d=this.octaves,e=this.frequency,f=this.persistence,g=a.slice(),h=g.length;for(var i=0;i<d;++i){var j=i*4096;for(var k=0;k<h;++k)g[k]=a[k]*e+j;b+=this._smooth(g,h-1)*c,c*=f,e*=2}var l=(1-f)/(1-c);return b*l},_generate:function(a,b,c,d){if(d<0)return c(a,this._perlin(a));for(var e=a[d]+b[d];a[d]<e;++a[d])this._generate(a,b,c,d-1);return a[d]-=b[d],null},generate:function(a,b,c){this._generate(a,b,c,a.length-1)}}),Generator.Landscape=new JS.Class("Generator.Landscape",{initialize:function(){},applyRessources:function(a,b){return a>b&&a<=127?0:a<=b&&a>b-2?4:a<=b-2&&a>b-5?3:1}}),Generator.Mountain=new JS.Class("Generator.Mountain",{initialize:function(){},applyRessources:function(a,b){return a>b&&a<=127?0:a<=b&&a>b-5?2:1}}),Generator.Ocean=new JS.Class("Generator.Ocean",{initialize:function(){},applyRessources:function(a,b){return a>64&&a<=127?0:a<=64&&a>b?6:1}}),Generator.BiomeGeneratorBase=new JS.Class("Generator.BiomeGeneratorBase",{initialize:function(){this.level=new Generator.LevelGenerator,this.landscape=new Generator.Landscape,this.ocean=new Generator.Ocean,this.mountain=new Generator.Mountain},applyBiome:function(a,b,c){var d;c<=64?d=this.ocean.applyRessources:c>64&&c<=80?d=this.landscape.applyRessources:c>80&&c<=127&&(d=this.mountain.applyRessources),a.makeLevelAt(b,c,d)},generate:function(a){var b=this,c=function(c,d){var e=[c[0]-a.position.x*16,c[1]-a.position.z*16];b.applyBiome(a,e,Math.floor(d*64)+50)};return this.level.generate([a.position.x*16,a.position.z*16],[16,16],c),a}}),Generator.Caverne=new JS.Class("Generator.Caverne",{initialize:function(){this.level1=new Generator.LevelGenerator,this.level2=new Generator.LevelGenerator,this.high=new Generator.LevelGenerator},generate:function(a){this.value=0,this.value2=0,this.value3=0,this.chunk=a,that=this;var b=function(a,b){that.value3=b*32;var c=[a[0]-that.chunk.position.x*16,a[1]-that.chunk.position.z*16];that.chunk.eraseBlocksBetwin(c[0],c[1],Math.floor(that.value+that.value3),Math.floor(that.value2+that.value3))},c=function(a,c){that.value2=c*100,that.value<that.value2&&that.high.generate([a[0],a[1]],[1,1],b)},d=function(a,b){that.value=b*100,that.level2.generate([a[0],a[1]],[1,1],c)};return this.level1.generate([that.chunk.position.x*16,that.chunk.position.z*16],[16,16],d),that.chunk}}),Generator.BiomeGeneratorAdvanced=new JS.Class("Generator.BiomeGeneratorAdvanced",{initialize:function(){this.caverne=new Generator.Caverne},generate:function(a){return a=this.caverne.generate(a),a}}),Generator.Base=new JS.Class("Generator.Base",{initialize:function(){this.BiomeBase=new Generator.BiomeGeneratorBase,this.BiomeAdvanced=new Generator.BiomeGeneratorAdvanced},generate:function(a,b){var c=new Generator.Chunk(a,b);return c=this.BiomeBase.generate(c),c=this.BiomeAdvanced.generate(c),c.dumpAllBlocks(),c}}),global.Persistor={},Persistor.Base=new JS.Class("Persistor.Base",{has:function(){Helper.pure("Persistor.Base:has")},load:function(){Helper.pure("Persistor.Base:load")},save:function(){Helper.pure("Persistor.Base:save")}}),Persistor.Volatile=new JS.Class("Persistor.Volatile",Persistor.Base,{has:function(){return!1},load:function(){return!1},save:function(){return!1}}),Server.Base=new JS.Class("Server.Base",{include:JS.Observable,initialize:function(){this.multiplexer=null,this.generator=new Generator.Base,this.persistor=new Persistor.Volatile,this.logic=new Logic.Apis},bootstrap:function(){this.plug(Server.Core.Logger.Plugin),this.plug(Server.Core.Loader.Plugin),this.plug(Server.Core.Protocol.Plugin),this.plug(Server.Core.Player.Plugin);var a=new Server.Event.State.Bootstrap;this.notifyObservers(a)},plug:function(a){a.attachServer(this)}}),Server.Core={},Server.Core.Logger={},Server.Core.Logger.Plugin=new JS.Class("Server.Core.Logger.Plugin",{extend:{attachServer:function(a){new this(a)}},initialize:function(a){this.server=a,this.server.addObserver(this.method("serverObserver")),this.server.multiplexer.addObserver(this.method("multiplexerObserver"))},log:function(a){console.log("[Server] "+a)},serverObserver:function(a){switch(a.klass){case Server.Event.State.Bootstrap:this.log("Server bootstraped !");break;case Server.Core.Loader.Event.Generated:this.log("Chunk generated");break;case Server.Core.Loader.Event.Loaded:this.log("Chunk loaded from cache")}},multiplexerObserver:function(a){switch(a.klass){case Pipeline.Event.Connection:this.log("Connection started.");break;case Pipeline.Event.Disconnection:this.log("Connection dropped.")}}}),Server.Event={},Server.Event.Base=new JS.Class("Server.Event.Base",{}),Server.Event.State=new JS.Class("Server.Event.State",Server.Event.State,{}),Server.Event.State.Base=new JS.Class("Server.Event.State.Base",Server.Event.Base,{}),Server.Event.State.Bootstrap=new JS.Class("Server.Event.State.Bootstrap",Server.Event.State.Base,{}),Server.Core.Loader={},Server.Core.Loader.Event={},Server.Core.Loader.Event.Generated=new JS.Class("Server.Core.Loader.Event.Generated",Event.Base,{}),Server.Core.Loader.Event.Loaded=new JS.Class("Server.Core.Loader.Event.Loaded",Event.Base,{}),Server.Core.Loader.Plugin=new JS.Class("Server.Core.Loader.Plugin",{extend:{attachServer:function(a){new this(a)}},initialize:function(a){this.server=a,this.server.logic.addObserver(this.method("observer"))},observer:function(a){if(a.klass==Logic.Event.Voxel.Access){var b=this.server,c=b.logic,d=a.coord();if(!c.voxels.hasOwnProperty(d)){var e,f=d.clone().substractSelf(d.clone().moduloScalar(20)),g=b.persistor;if(g.has(d)){e=g.load(d);var h=new Server.Core.Loader.Event.Loaded(d,e);b.notifyObservers(i)}else{e=b.generator.generate(d,20),g.save(d,e);var i=new Server.Core.Loader.Event.Generated(d,e);b.notifyObservers(i)}c.injectVoxelChunk(f,e)}}}}),Logic.Event.Base=new JS.Class("Logic.Event.Base",Event.Base,{}),Logic.Event.Voxel.Base=new JS.Class("Logic.Event.Voxel.Base",Logic.Event.Base,{initialize:function(a){this._point=a},coord:function(){return this._point}}),Logic.Event.Voxel.Access=new JS.Class("Logic.Event.Voxel.Access",Logic.Event.Voxel.Base,{}),Server.Core.Protocol={},Server.Core.Protocol.Plugin=new JS.Class("Server.Core.Protocol.Plugin",{extend:{attachServer:function(a){new this(a)}},initialize:function(a){this.server=a,this.server.multiplexer.addObserver(this.method("observer")),this.playersCount=0},observer:function(a){switch(a.klass){case Pipeline.Event.Disconnection:this.onDisconnection(a);break;case Pipeline.Event.Command:var b="on"+a.command[0].toUpperCase()+a.command.substr(1)+"Command";b in this&&this[b](a)}},onDisconnection:function(a){var b=a.pipeline,c=new Server.Core.Protocol.Event.Player.Part;c.pipeline=b,this.server.notifyObservers(c)},onHandshakeCommand:function(a){var b=a.pipeline,c=b.id,d=new Server.Core.Protocol.Event.Connection.Accept;d.pipeline=b,this.server.multiplexer.notifyObservers(d),a.aknowledge(c);var e=new Server.Core.Protocol.Event.Player.Join;e.pipeline=b,e.playerId=c,e.position=new Value3(0,0,0),e.orientation=new Value3(0,0,0),this.server.notifyObservers(e)},onPlayerMoveCommand:function(a){var b=new Server.Core.Protocol.Event.Player.Move;b.pipeline=a.pipeline,b.position=Value3.fromArray(a.position),b.rotation=Value3.fromArray(a.rotation),this.server.notifyObservers(b)}}),Server.Core.Protocol.Event={},Server.Core.Protocol.Event.Connection={},Server.Core.Protocol.Event.Base=new JS.Class("Server.Core.Protocol.Event.Base",Event.Base,{}),Server.Core.Protocol.Event.Connection.Base=new JS.Class("Server.Core.Protocol.Event.Connection.Base",{}),Server.Core.Protocol.Event.Connection.Accept=new JS.Class("Server.Core.Protocol.Event.Connection.Accept",Server.Core.Protocol.Event.Connection.Base,{}),Server.Core.Protocol.Event.Connection.Deny=new JS.Class("Server.Core.Protocol.Event.Connection.Deny",Server.Core.Protocol.Event.Connection.Base,{}),Server.Core.Protocol.Event.Player={},Server.Core.Protocol.Event.Player.Base=new JS.Class("Server.Core.Protocol.Event.Player.Base",Server.Core.Protocol.Event.Base,{}),Server.Core.Protocol.Event.Player.Join=new JS.Class("Server.Core.Protocol.Event.Player.Join",Server.Core.Protocol.Event.Player.Base,{}),Server.Core.Protocol.Event.Player.Part=new JS.Class("Server.Core.Protocol.Event.Player.Part",Server.Core.Protocol.Event.Player.Base,{}),Server.Core.Protocol.Event.Player.Base=new JS.Class("Server.Core.Protocol.Event.Player.Move",Server.Core.Protocol.Event.Player.Base,{}),Server.Core.Player={},Server.Core.Player.Plugin=new JS.Class("Server.Core.Player.Plugin",{extend:{attachServer:function(a){new this(a)}},initialize:function(a){this.server=a,this.server.addObserver(this.method("observer"))},observer:function(a){switch(a.klass){case Server.Core.Protocol.Event.Player.Join:this.server.multiplexer.send("playerJoin",{id:a.playerId,position:a.position.toArray(),orientation:a.orientation.toArray()});break;case Server.Core.Protocol.Event.Player.Part:this.server.multiplexer.send("playerPart",{id:a.playerId});break;case Server.Core.Protocol.Event.Player.Move:a.pipeline.broadcast.send("playerMove",{id:a.playerId,position:a.position.toArray(),orientation:a.orientation.toArray()})}}}),global.Pipeline.Multiplexer={},Pipeline.Multiplexer.Base=new JS.Class("Pipeline.Multiplexer.Base",{include:[JS.Observable],send:function(a,b,c){Helper.pure(this,"send")}}),Pipeline.Multiplexer.Remote=new JS.Class("Pipeline.Multiplexer.Remote",Pipeline.Multiplexer.Base,{initialize:function(a){var b=0;this.server=require("socket.io").listen(a),this.server.sockets.on("connection",function(a){var c=new Pipeline.Remote(a);c.id=++b,c.multiplexer=this,c.broadcast=new Pipeline.Broadcast.Remote(c),c.addObserver(function(a){this.notifyObservers(a)}.bind(this)),a.on("disconnect",function(){c.close(!0)}),c.finalize()}.bind(this))},send:function(a,b,c){this.server.sockets.emit("event",{command:a,data:b},c)}}),Pipeline.Broadcast={},Pipeline.Broadcast.Base=new JS.Class("Pipeline.Broadcast.Base",{send:function(a,b,c){Helper.pure(this,"send")}}),Pipeline.Broadcast.Remote=new JS.Class("Pipeline.Broadcast.Remote",Pipeline.Broadcast.Base,{initialize:function(a){this.pipeline=a},send:function(a,b,c){this.pipeline.broadcast.send(a,b,c)}}),Server.Remote=new JS.Class("Server.Remote",Server.Base,{initialize:function(a){this.callSuper(),this.multiplexer=new Pipeline.Multiplexer.Remote(a)}}),global.Node=new JS.Class("Node",{initialize:function(){var a=new Generator.Base;for(var b=0;b<8;b++)for(var c=0;c<8;c++)console.log("c "+b+" "+c),a.generate(b,c);console.log("Done")}}),new JS.Singleton("Main",{initialize:function(){var a=this;Helper.ifNodeContext(function(){new Node}),Helper.ifBrowserContext(function(){window.addEventListener("load",function(){new Browser},!1)})}});