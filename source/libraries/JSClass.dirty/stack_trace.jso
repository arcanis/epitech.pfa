JS.StackTrace=new JS.Module("StackTrace",{extend:{logger:new JS.Singleton({include:JS.Console,active:!1,update:function(a,b){if(!this.active)return;switch(a){case"call":return this.logEnter(b);case"return":return this.logExit(b);case"error":return this.logError(b)}},indent:function(){var a=" ";return JS.StackTrace.forEach(function(){a+="|  "}),a},fullName:function(a){var b=JS.Console,c=a.method,d=a.env,e=c.name,f=c.module;return b.nameOf(d)+(f===d?"":"("+b.nameOf(f)+")")+"#"+e},logEnter:function(a){var b=this.fullName(a),c=JS.Console.convert(a.args).replace(/^\[/,"(").replace(/\]$/,")");this._0&&this.puts(),this.reset(),this.print(" "),this.consoleFormat("bgblack","white"),this.print("TRACE"),this.reset(),this.print(this.indent()),this.blue(),this.print(b),this.red(),this.print(c),this.reset(),this._0=!0},logExit:function(a){var b=this.fullName(a);a.leaf?(this.consoleFormat("red"),this.print(" --> ")):(this.reset(),this.print(" "),this.consoleFormat("bgblack","white"),this.print("TRACE"),this.reset(),this.print(this.indent()),this.blue(),this.print(b),this.red(),this.print(" --> ")),this.consoleFormat("yellow"),this.puts(JS.Console.convert(a.result)),this.reset(),this.print(""),this._0=!1},logError:function(a){this.puts(),this.reset(),this.print(" "),this.consoleFormat("bgred","white"),this.print("ERROR"),this.consoleFormat("bold","red"),this.print(" "+JS.Console.convert(a)),this.reset(),this.print(" thrown by "),this.bold(),this.print(JS.StackTrace.top().name),this.reset(),this.puts(". Backtrace:"),this.backtrace()},backtrace:function(){JS.StackTrace.reverseForEach(function(a){var b=JS.Console.convert(a.args).replace(/^\[/,"(").replace(/\]$/,")");this.print("      | "),this.consoleFormat("blue"),this.print(a.name),this.red(),this.print(b),this.reset(),this.puts(" in "),this.print("      |  "),this.bold(),this.puts(JS.Console.convert(a.object))},this),this.reset(),this.puts()}}),include:[JS.Observable,JS.Enumerable],wrap:function(a,b,c){var d=JS.StackTrace,e=function(){var e;d.push(this,b,c,Array.prototype.slice.call(arguments));try{e=a.apply(this,arguments)}catch(h){d.error(h)}return d.pop(e),e};return e.toString=function(){return a.toString()},e.__traced__=!0,e},stack:[],forEach:function(a,b){JS.Enumerable.forEach.call(this.stack,a,b)},top:function(){return this.stack[this.stack.length-1]||{}},push:function(a,b,c,d){var e=this.stack;e.length>0&&(e[e.length-1].leaf=!1);var f={object:a,method:b,env:c,args:d,leaf:!0};f.name=this.logger.fullName(f),this.notifyObservers("call",f),e.push(f)},pop:function(a){var b=this.stack.pop();b.result=a,this.notifyObservers("return",b)},error:function(a){throw a.logged?a:(a.logged=!0,this.notifyObservers("error",a),this.stack=[],a)}}}),JS.StackTrace.addObserver(JS.StackTrace.logger);