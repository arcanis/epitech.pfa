JS.Command=new JS.Class("Command",{initialize:function(a){typeof a=="function"&&(a={execute:a}),this._2=a,this._0=this._2.stack||null},execute:function(a){this._0&&this._0._3();var b=this._2.execute;b&&b.apply(this),this._0&&a!==!1&&this._0.push(this)},undo:function(){var a=this._2.undo;a&&a.apply(this)},extend:{Stack:new JS.Class({include:[JS.Observable||{},JS.Enumerable||{}],initialize:function(a){a=a||{},this._1=a.redo||null,this.clear()},forEach:function(a,b){if(!a)return this.enumFor("forEach");a=JS.Enumerable.toFn(a);for(var c=0,d=this._0.length;c<d;c++)this._0[c]!==undefined&&a.call(b||null,this._0[c],c);return this},clear:function(){this._0=[],this.length=this.pointer=0},_3:function(){this.pointer===0&&this._1&&this._1.execute&&this._1.execute()},push:function(a){this._0.splice(this.pointer,this.length),this._0.push(a),this.length=this.pointer=this._0.length,this.notifyObservers&&this.notifyObservers(this)},stepTo:function(a){if(a<0||a>this.length)return;var b,c;switch(!0){case a>this.pointer:for(b=this.pointer,c=a;b<c;b++)this._0[b].execute(!1);break;case a<this.pointer:if(this._1&&this._1.execute){this._1.execute();for(b=0,c=a;b<c;b++)this._0[b].execute(!1)}else for(b=0,c=this.pointer-a;b<c;b++)this._0[this.pointer-b-1].undo()}this.pointer=a,this.notifyObservers&&this.notifyObservers(this)},undo:function(){this.stepTo(this.pointer-1)},redo:function(){this.stepTo(this.pointer+1)}})}});