JS.State=new JS.Module("State",{__getState__:function(a){return typeof a=="object"?a:typeof a=="string"?(this.states||{})[a]:{}},setState:function(a){this.__state__=this.__getState__(a),JS.State.addMethods(this.__state__,this.klass)},inState:function(){var a=arguments.length;while(a--)if(this.__state__===this.__getState__(arguments[a]))return!0;return!1},extend:{ClassMethods:new JS.Module({states:function(a){this.define("states",JS.State.buildCollection(this,a))}}),included:function(a){a.extend(this.ClassMethods)},stub:function(){return this},buildStubs:function(a,b,c){var d,e;for(d in c){b[d]={};for(e in c[d])a[e]=this.stub}},findStates:function(a,b){var c=a.length,d=[];while(c--)a[c].hasOwnProperty(b)&&d.push(a[c][b]);return d},buildCollection:function(a,b){var c={},d={},e=a.lookup("states"),f,g,h,i,j,k,l;this.buildStubs(c,d,b);for(k=0,l=e.length;k<l;k++)this.buildStubs(c,d,e[k]);for(f in d){g=new JS.Class(b[f]),j=this.findStates(e,f),k=j.length;while(k--)j[k]&&g.include(j[k].klass);h={};for(i in c)g.prototype[i]||(h[i]=c[i]);g.include(h),d[f]=new g}return a.__tgt__&&this.addMethods(c,a.__tgt__.klass),d},addMethods:function(a,b){if(!b)return;var c={},d=b.prototype,e;for(e in a){if(d[e])continue;b.define(e,this.wrapped(e))}},wrapped:function(a){return function(){var b=(this.__state__||{})[a];return b?b.apply(this,arguments):this}}}});