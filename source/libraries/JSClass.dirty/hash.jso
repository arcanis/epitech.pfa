JS.Hash=new JS.Class("Hash",{include:JS.Enumerable||{},extend:{Pair:new JS.Class({include:JS.Comparable||{},length:2,setKey:function(a){this[0]=this.key=a},hasKey:function(a){return JS.Enumerable.areEqual(this.key,a)},setValue:function(a){this[1]=this.value=a},hasValue:function(a){return JS.Enumerable.areEqual(this.value,a)},compareTo:function(a){return this.key.compareTo?this.key.compareTo(a.key):this.key<a.key?-1:this.key>a.key?1:0},hash:function(){var a=JS.Hash.codeFor(this.key),b=JS.Hash.codeFor(this.value);return[a,b].sort().join("/")}}),codeFor:function(a){return typeof a!="object"?String(a):typeof a.hash=="function"?a.hash():a.toString()}},initialize:function(a){this.clear();if(!JS.isType(a,Array))return this.setDefault(a);for(var b=0,c=a.length;b<c;b+=2)this.store(a[b],a[b+1])},forEach:function(a,b){if(!a)return this.enumFor("forEach");a=JS.Enumerable.toFn(a);var c,d,e;for(c in this._0){if(!this._0.hasOwnProperty(c))continue;d=this._0[c],e=d.length;while(e--)a.call(b||null,d[e])}return this},_7:function(a,b){var c=this.klass.codeFor(a),d=this._0[c];return!d&&b&&(d=this._0[c]=[]),d},_8:function(a,b){var c=a.length,d=!!this._5;while(c--)if(d?a[c].key===b:a[c].hasKey(b))return c;return-1},assoc:function(a,b){var c,d,e;return c=this._7(a,b),c?(d=this._8(c,a),d>-1?c[d]:b?(this.size+=1,this.length+=1,e=new this.klass.Pair,e.setKey(a),c.push(e),e):null):null},rassoc:function(a){var b=this.key(a);return b?this.assoc(b):null},clear:function(){this._0={},this.length=this.size=0},compareByIdentity:function(){return this._5=!0,this},comparesByIdentity:function(){return!!this._5},setDefault:function(a){return this._6=a,this},getDefault:function(a){return typeof this._6=="function"?this._6(this,a):this._6||null},equals:function(a){if(!JS.isType(a,JS.Hash)||this.length!==a.length)return!1;var b=!0;return this.forEach(function(e){if(!b)return;var f=a.assoc(e.key);if(f===null||!f.hasValue(e.value))b=!1}),b},hash:function(){var a=[];return this.forEach(function(c){a.push(c.hash())}),a.sort().join("")},fetch:function(a,b,c){var d=this.assoc(a);if(d)return d.value;if(b===undefined)throw new Error("key not found");return typeof b=="function"?b.call(c||null,a):b},forEachKey:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(d){a.call(b||null,d.key)}),this):this.enumFor("forEachKey")},forEachPair:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(d){a.call(b||null,d.key,d.value)}),this):this.enumFor("forEachPair")},forEachValue:function(a,b){return a?(a=JS.Enumerable.toFn(a),this.forEach(function(d){a.call(b||null,d.value)}),this):this.enumFor("forEachValue")},get:function(a){var b=this.assoc(a);return b?b.value:this.getDefault(a)},hasKey:function(a){return!!this.assoc(a)},hasValue:function(a){var b=!1,c=!!this._5;return this.forEach(function(e){if(b)return;if(c?a===e.value:JS.Enumerable.areEqual(a,e.value))b=!0}),b},invert:function(){var a=new this.klass;return this.forEach(function(c){a.store(c.value,c.key)}),a},isEmpty:function(){for(var a in this._0)if(this._0.hasOwnProperty(a)&&this._0[a].length>0)return!1;return!0},key:function(a){var b=null;return this.forEach(function(d){!b&&JS.Enumerable.areEqual(a,d.value)&&(b=d.key)}),b},keys:function(){var a=[];return this.forEach(function(c){a.push(c.key)}),a},merge:function(a,b,c){var d=new this.klass;return d.update(this),d.update(a,b,c),d},rehash:function(){var a=new this.klass;a._0=this._0,this.clear(),this.update(a)},remove:function(a,b){b===undefined&&(b=null);var c,d,e;return c=this._7(a),c?(d=this._8(c,a),d<0?typeof b=="function"?this.fetch(a,b):this.getDefault(a):(e=c[d].value,this._9(c,d),this.size-=1,this.length-=1,c.length===0&&delete this._0[this.klass.codeFor(a)],e)):typeof b=="function"?this.fetch(a,b):this.getDefault(a)},_9:function(a,b){a.splice(b,1)},removeIf:function(a,b){if(!a)return this.enumFor("removeIf");a=JS.Enumerable.toFn(a);var c=[];this.forEach(function(d){a.call(b||null,d)&&c.push(d.key)},this);var d=c.length;while(d--)this.remove(c[d]);return this},replace:function(a){this.clear(),this.update(a)},shift:function(){var a=this.keys();if(a.length===0)return this.getDefault();var b=this.assoc(a[0]);return this.remove(b.key),b},store:function(a,b){return this.assoc(a,!0).setValue(b),b},toString:function(){return"Hash:{"+this.map(function(a){return a.key.toString()+"=>"+a.value.toString()}).join(",")+"}"},update:function(a,b,c){var d=typeof b=="function";a.forEach(function(a){var h=a.key,i=a.value;d&&this.hasKey(h)&&(i=b.call(c||null,h,this.get(h),i)),this.store(h,i)},this)},values:function(){var a=[];return this.forEach(function(c){a.push(c.value)}),a},valuesAt:function(){var a=arguments.length,b=[];while(a--)b.push(this.get(arguments[a]));return b}}),JS.Hash.alias({includes:"hasKey",index:"key",put:"store"}),JS.OrderedHash=new JS.Class("OrderedHash",JS.Hash,{assoc:function(a,b){var c=JS.Hash.prototype.assoc,d=c.call(this,a,!1);if(d||!b)return d;var e=c.call(this,a,!0);return this._2?(this._3._1=e,e._4=this._3,this._3=e):this._2=this._3=e,e},clear:function(){this.callSuper(),this._2=this._3=null},_9:function(a,b){var c=a[b];return c._4&&(c._4._1=c._1),c._1&&(c._1._4=c._4),c===this._2&&(this._2=c._1),c===this._3&&(this._3=c._4),this.callSuper()},forEach:function(a,b){if(!a)return this.enumFor("forEach");a=JS.Enumerable.toFn(a);var c=this._2;while(c)a.call(b||null,c),c=c._1},rehash:function(){var a=this._2;this.clear();while(a)this.store(a.key,a.value),a=a._1}});